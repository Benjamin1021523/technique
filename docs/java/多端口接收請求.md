---
title: 多端口接收請求
---
<!--關鍵字: spring boot, undertow, port設定-->

# 多端口接收請求

一個服務不只使用一個端口(port)，而能夠開放多個、並決定這些端口對誰開放。

## 使用套件

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-undertow</artifactId>
    <version>3.5.4</version>
</dependency>
```

## 簡單的範例

透過`@Configuration`在spring boot服務啟動時進行設定

使用`@Slf4j`寫入執行紀錄

```java
@Configuration
@Slf4j
public class ServerConfig {

    /**
     * undertow服務器下http重定向到https
     */
    @Value("${server.http.ports:}")
    private List<Integer> httpPorts;
    @Bean
    public ServletWebServerFactory servletWebServerFactory() {
        log.info("設定http");
        UndertowServletWebServerFactory undertowFactory = new UndertowServletWebServerFactory();
        undertowFactory.addBuilderCustomizers((Undertow.Builder builder) -> {
            if (!httpPorts.isEmpty()) {
                log.info("指定http port: " + httpPorts);
                for (Integer httpPort : httpPorts) {
                    builder.addHttpListener(httpPort, "0.0.0.0");
                }
                // 開啓HTTP2
                builder.setServerOption(UndertowOptions.ENABLE_HTTP2, true);
            }
        });
        return undertowFactory;
    }
}
```

讀取設定值`server.http.ports`取得要設定的零到多個port(沒設定或等於空字串都會讓數字list變為null)，逐一設定開放的port，以及開放呼叫的host為`0.0.0.0`

### 定義host是做什麼用的？

host會控制允許呼叫的來源，總共有兩種設定方式

一個是`192.168.1.1`，指定開放給特定IP呼叫，`127.0.0.1`也是，只不過限制呼叫的對象是本機

另一個是`0.0.0.0`，意思就是不限制來源

所以把上面的程式拿來解釋各情況如下
```java
// 增加一條規則A：開放8080 port，允許任何人呼叫
builder.addHttpListener(8080, "0.0.0.0");
// 增加一條規則B：開放8081 port，但只允許192.168.1.1呼叫
builder.addHttpListener(8081, "192.168.1.1");
// 增加一條規則C：開放8081 port，但只允許192.168.1.2呼叫
builder.addHttpListener(8081, "192.168.1.2");
// 增加一條規則D：開放8082 port，但只允許本機呼叫
builder.addHttpListener(8082, "127.0.0.1");
```

這些添加的監聽器(listener)不會互相影響，所以上面用`增加一條規則`的方式敘述，符合的請求就能進來

像是規則B和C是對不同對象開放8081 port的呼叫，意思就會是兩來源都可使用

## 什麼時候會需要設定？

* 服務希望提供多種port呼叫
* 有設定SSL啟用https，但又希望保留http呼叫方式

# 其他QA

<!--Finish-->